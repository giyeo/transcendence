<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Pong!</title>
	<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap">
</head>
<body>
	<div id="paddleA"	class="paddle"></div>
	<div id="paddleB"	class="paddle"></div>
	<div id="ball"		class="ball"></div>
	<div id="tail">	</div>
	<div id="horizontalWallLeft"	class="horizontalWall"	style="top: 0px;		left: 400px;"></div>
	<div id="horizontalWallRight"	class="horizontalWall"	style="top: 310px;		left: 400px; background-color: rgba(200,200,200,0.2);"></div>
	<div id="horizontalWallMid"		class="horizontalWall"	style="top: 620px;		left: 400px;"></div>
	<div id="verticalWall"			class="verticalWall"	style="top: 20px;		left: 790px;"></div>
	<div id="scoreA"				class="score"			style="top: 60px;		left: 650px;">0</div>
	<div id="scoreB"				class="score"			style="top: 60px;		left: 860px;">0</div>

	<!-- 
	<div class="info"			style="top: {650}px;	left: {leftShift + 0}px;">{stop} 800x600px object width 20px, paddle 100px</div>
	<div class="info"			style="top: {650}px;	left: {leftShift + 900}px;">vel:{ball.velocity} deg:{toDegre(ball.radians)} \n angle:{rad(ball.radians)}</div> -->

	<!-- <audio id="paddle" src="./paddle.mp3"></audio>
	<audio id="wall" src="./wall.mp3"></audio>
	<audio id="score" src="./score.mp3"></audio> -->
</body>
</html>

<script lang="js">
	let framerate = 16; //16 = 60fps
	let player = 'A'
	let leftShift = 400;
	let scoreA = 0;
	let scoreB = 0;
	let paddleAx = leftShift + 35;
	let paddleBx = leftShift + 745;
	let paddleAy = 20 + 300 - 50;
	let paddleBy = 20 + 300 - 50;
	let paddleSize = 100;
	let topWall = 20;
	let botWall = 600;
	let resetx = 400 - 10 + leftShift
	let resety = 300 + 10
	var stop = 1;
	var ball = {
			x: resetx,
			y: resety,
			radians: rad(315),
			velocity: 5
		};
	
	async function goToPosition(newX, newY) {//interpolation, adding frames between
		var oldX = ball.x;
		var oldY = ball.y;
		var DLSS = 4;
		var i = 0
		if(Math.abs(newX-oldX) < 300 ) {
			while(i < DLSS) {
				ball.x += ((newX - oldX) / DLSS );
				ball.y += ((newY - oldY) / DLSS );
				await sleep(framerate / DLSS );
				i++;
			}
		}
		ball.x = newX;
		ball.y = newY;
	}

	let url = `ws://${window.location.host}/ws/socket-server/`
	const gameSocket = new WebSocket(url)

	gameSocket.onopen = function(e) {
		gameSocket.send(JSON.stringify({
			'join': 'Joined game'
		}))
	}

	gameSocket.onmessage = function(e){
		let data = JSON.parse(e.data)
		console.log('Data:', data)
		if(player === 'B')
			paddleAy = data.data.aY; //dont receive myself, only if i'm player B
		else
			paddleBy = data.data.bY;
		//ball.x = data.data.ballX;
		//ball.y = data.data.ballY;
		goToPosition(data.data.ballX, data.data.ballY)
		ball.radians = data.data.ballRad;
		ball.velocity = data.data.ballVelocity;
		scoreA = data.data.scoreA;
		scoreB = data.data.scoreB;
		if(scoreA > 10 || scoreB > 10) {
				scoreA = 0;
				scoreB = 0;
		}
		updateElementPosition();
	}

	const game = () => {
		if (gameSocket.readyState === WebSocket.OPEN) {
			gameSocket.send(JSON.stringify({
				aY: paddleAy,
				bY: paddleBy,
			}))
		}
	};

	function playAudio(name) {
		// const audio = document.getElementById(name);
		// audio.play();
  	}

	function rad(x) {
    	return ((x % 360) * (Math.PI / 180)) % 360;
	}

	function toDegre(x) {
		return (x / Math.PI) * 180;
	}

	var ballPositionHistory = [];
	const container = document.getElementById('tail');

	function addPosition(x, y) {
		// Add the new position to the list
		ballPositionHistory.push({ x, y });

		// If the list exceeds the maximum length, remove the oldest element and its corresponding child element
		if (ballPositionHistory.length > 25) {
			const removedItem = ballPositionHistory.shift();
			const removedChild = container.querySelector(`[data-x="${removedItem.x}"][data-y="${removedItem.y}"]`);
			container.removeChild(removedChild);
		}

		// Create a new <div> element for the new position
		const ballElement = document.createElement('div');
		ballElement.className = 'ball';
		ballElement.style.top = `${y}px`;
		ballElement.style.left = `${x}px`;
		ballElement.style.opacity = '0.1';

		// Set custom attributes to identify this element
		ballElement.setAttribute('data-x', x);
		ballElement.setAttribute('data-y', y);

		// Append the new <div> element to the container
		container.appendChild(ballElement);
	}

	function soundByPosition() {
		if (ball.x < leftShift || ball.x > leftShift + 800) {
			playAudio("score");
		}

		if ( (ball.y > paddleAy && ball.y < paddleAy + paddleSize ) 
		&& (ball.x > paddleAx - 10 && ball.x < paddleAx + 20)) {
			playAudio("paddle");
		}
	
		if ( (ball.y > paddleBy && ball.y < paddleBy + paddleSize ) 
		&& (ball.x > paddleBx - 20 && ball.x < paddleBx + 10)) {
			playAudio("paddle");
		}

		if (ball.y <= topWall || ball.y >= botWall) {
			playAudio("wall");
		}
	}

	function sleep(ms) {
		return new Promise(resolve => setTimeout(resolve, ms));
	}

	async function gameloop() {
		while(1) {
			game()
			addPosition(ball.x, ball.y);
			soundByPosition();
			await sleep(framerate);
		}
	}

	gameloop();
	//800px x 600px //////////////////////////////////////////////////////////////////////q

	let keyDownInterval = null;
	let isKeyDown = false; // Flag to track key press
	function startContinuousMove(direction) {
		if (!isKeyDown) {
			isKeyDown = true;
			keyDownInterval = setInterval(() => {
				if (direction === 'up' && paddleAy >= 30) {
					paddleAy -= 10; // Move rectangle 1 upward
					// paddleBy -= 10;
				} else if (direction === 'down' && paddleAy < 520) {
					paddleAy += 10; // Move rectangle 2 downward
					// paddleBy += 10;
				}
				updateElementPosition();
			}, 16); // Adjust the interval as needed for desired speed
		}
	}

	function stopContinuousMove() {
		clearInterval(keyDownInterval);
		isKeyDown = false; // Reset the flag
	}

	// Handle keydown and keyup events
	function handleKeyDown(event) {
		if (event.key === 'ArrowUp') {
			startContinuousMove('up');
		} else if (event.key === 'ArrowDown') {
			startContinuousMove('down');
		}
	}

	function handleKeyUp(event) {
		if (event.key === 'ArrowUp' || event.key === 'ArrowDown') {
			stopContinuousMove();
		}
		if (event.code === 'Space') {
			if(stop < 0)
				gameloop();
			stop = stop * -1;
		}
	}
	// Attach keydown and keyup event listeners to the document
	document.addEventListener('keydown', handleKeyDown);
	document.addEventListener('keyup', handleKeyUp);

	document.addEventListener('DOMContentLoaded', function() {
		console.log(aY)
    	updateElementPosition();
    });

	function updateElementPosition() {
		let element = document.getElementById('paddleA'); // Replace with your element's actual ID
		element.style.top = `${paddleAy}px`;
		element.style.left = `${paddleAx}px`;
		element = document.getElementById('paddleB'); // Replace with your element's actual ID
		element.style.top = `${paddleBy}px`;
		element.style.left = `${paddleBx}px`;
		element = document.getElementById('ball'); // Replace with your element's actual ID
		element.style.top = `${ball.y}px`;
		element.style.left = `${ball.x}px`;
		element = document.getElementById('scoreA'); // Replace with your element's actual ID
		element.innerHTML = `${scoreA}`;
		element = document.getElementById('scoreB'); // Replace with your element's actual ID
		element.innerHTML = `${scoreB}`;
		element = document.getElementById('tail'); // Replace with your element's actual ID
		ballPositionHistory.forEach((item, index) => {
			//const ballElement = document.createElement('div');
			
			//ballElement.className = 'ball';
			//ballElement.style.top = `${item.y - 480}px`;
			//ballElement.style.left = `${item.x - 890}px`;
			//ballElement.style.opacity = '0.1';
			//element.appendChild(ballElement);
		});
	}
</script>

<style>
	body {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    margin: 0;
	background-color: grey;
}

.paddle {
    width: 20px;
    height: 100px;
    background-color: black;
    position: absolute;
	z-index: 99;
}

.horizontalWall {
	width: 800px;
	height: 20px;
	background-color: black;
	position: absolute;
}

.verticalWall {
	width: 20px;
	border-left: 20px dashed black;
	height: 600px;
	position: absolute;
}

.ball {
	height: 20px;
	width: 20px;
	background-color: black;
	border-radius: 100%;
	position: absolute;
  }

.score {
    font-family: 'Press Start 2P', cursive;
	font-size: 100px;
	position: absolute;
}

.info {
    font-family: 'Press Start 2P', cursive;
	font-size: 20px;
	position: absolute;
}
</style>
