{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Pong!</title>
	<link rel="icon" type="image/x-icon" href="{% static 'game/favicon.ico' %}">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap">
	<link rel="stylesheet" type="text/css" href="{% static 'game/style.css' %}">
	<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
	<meta http-equiv="Pragma" content="no-cache">
	<meta http-equiv="Expires" content="0">
	<script src="{% static 'game/app.js' %}" defer></script>
</head>
<body>
	<div id="login">
		{% include './login.html' %}
	</div>

	<div id="loading" style="display: none;">
		{% include './loading.html' %}
	</div>

	<div id="menu" style="display: none;">
		{% include './menu.html' %}
	</div>

	<div id="game" style="display: none;">
		{% include './game.html' %}
	</div>
</body>
</html>

<script>
	var userData;
	var randomUserData;
	var intraCode;

	function getIntraCode() {
		const urlParams = new URLSearchParams(window.location.search);
		console.log(urlParams);
		if (urlParams.has('code')) {
			intraCode = urlParams.get('code');
			goToMenu();
		}
		if (urlParams.has('error')) {
			console.log('Code:', urlParams.get('error'));
		}
	}

	API_URL = "http://127.0.0.1:8000"

	function getUserData() {
		return new Promise((resolve, reject) => {
			const apiUrl = API_URL + '/game/data';

			// Append the 'code' parameter to the URL
			const apiUrlWithParams = `${apiUrl}?code=${encodeURIComponent(intraCode)}`;

			// Make a GET request to the Django endpoint with the 'code' parameter
			fetch(apiUrlWithParams)
				.then(response => {
					if (!response.ok) {
						throw new Error('Network response was not ok');
					}
					return response.json();
				})
				.then(data => {
					// Handle the data from the response
					userData = data
					console.log('Data from Django:', data);
					resolve(data)
				})
				.catch(error => {
					console.error('There was a problem with the fetch operation:', error);
					resolve(error)
			});
		});
	};

	function mountMenu() {
		let img = "";
		let displayname = "";
		let login = "";
		if(randomUserData) {
			img = randomUserData.picture.large
			displayname = randomUserData.name.first + randomUserData.name.last
			login = randomUserData.login.username
		}
		if(userData) {
			img = userData.image.link
			displayname = userData.displayname
			login = userData.login
		}
		
		document.getElementById("image").src = img;
		document.getElementById("displayName").innerText = displayname;
		document.getElementById("loginName").innerText = login;
	}

	function getRandomUserData() {
		return new Promise((resolve, reject) => {
			fetch('https://randomuser.me/api/')
			.then(response => {
				if (!response.ok) {
				throw new Error('Network response was not ok');
				}
				return response.json();
			})
			.then(data => {
				randomUserData = data.results[0]
				//console.log(data.results[0]);
				resolve(data)
			})
			.catch(error => {
				console.error('There was a problem with the fetch operation:', error);
				resolve(error)
			});
		})
	}

	async function goToMenu(asGuest) {
		document.getElementById("login").style.display = "none";
		document.getElementById("menu").style.display = "none";
		document.getElementById("loading").style.display = "block";
		try {
			if(intraCode)
				await getUserData();
			else
				await getRandomUserData();
			mountMenu();
			document.getElementById("loading").style.display = "none";
			document.getElementById("menu").style.display = "block";
			//history.pushState({page: 'menu'}, 'menu', '/menu/');
		} catch (error) {
			console.error('Error getting user data:', error);
			document.getElementById("login").style.display = "block";
			document.getElementById("loading").style.display = "none";
		}
	}

	async function verifyOTP(otp) {
		return new Promise((resolve, reject) => {
				fetch(API_URL + '/game/verifyOTP?&otp=' + otp, {headers: {'Authorization': 'Bearer ' + userData.access_token}})
					.then(response => {
						console.log("QR code received")
						return response.status;
					})
					.then(data => {
						resolve(data)
					})
					.catch(error => {
						console.error('There was a problem with the fetch operation:', error);
						resolve(error);
					});
			})
	}

	async function sendOTP() {
		otpText = document.getElementById('2fa-input');
		qrcodeImage = document.getElementById('2fa-button-qrcode');
		inputOTP = document.getElementById('inputOTP')
		a = await verifyOTP(otpText.value)
		console.log(a)
		if(a === 200) {
			otpText.value = ""
			qrcodeImage.style.display = "none"
			inputOTP.style.display = "none"
		}
	}

	async function getQRCode() {
		qrcodeImage = document.getElementById('2fa-button-qrcode');
		qrcode = await new Promise((resolve, reject) => {
				fetch(API_URL + '/game/qrcode', {headers: {'Authorization': 'Bearer ' + userData.access_token}})
					.then(response => {
						console.log("QR code received")
						return response.blob();
					})
					.then(blob => {
						resolve(blob)
					})
					.catch(error => {
						console.error('There was a problem with the fetch operation:', error);
						resolve(error);
					});
			})

		qrcodeImage.src = URL.createObjectURL(qrcode);
		qrcodeImage.style.display = "block";
	}

	function setupSinglePageApplication() {
		getIntraCode();
		
		//history.pushState({page: 'login'}, 'login', '/login/');

		findMatch = document.getElementById('find-match');
		findMatch.addEventListener('click', () => {
			document.getElementById("menu").style.display = "none";
			document.getElementById("game").style.display = "block";
			if (!gameSocket) {
				startGame(userData);
			}
		});
		
		button2fa = document.getElementById('2fa-button');
		button2fa.addEventListener('click', () => {
			getQRCode()
		});
		
		sendOTPHandler = document.getElementById('sendOTP');
		sendOTPHandler.addEventListener('click', () => {
			sendOTP();
		});

		loginGuest = document.getElementById('login-guest');
		loginGuest.addEventListener('click', () => {
			goToMenu();
		});


		loginIntra = document.getElementById('login-intra');
		loginIntra.addEventListener('click', () => {
			console.log("Redirecting...");
			window.location.href = "https://api.intra.42.fr/oauth/authorize?client_id=u-s4t2ud-d7f64afc7fb7dc2840609df8b5328f172dd434549cf932c6606762ecb4016c2d&redirect_uri=http%3A%2F%2F127.0.0.1%3A8000%2Fgame&response_type=code";
		});
	}

	//window.addEventListener('popstate', (event) => {
	//	if (event.state === null) {
	//		return;
	//	}
	//	if (event.state.page === 'login') {
	//		document.getElementById("login").style.display = "block";
	//		document.getElementById("menu").style.display = "none";
	//	}
	//	if (event.state.page === 'menu') {
	//		document.getElementById("login").style.display = "none";
	//		document.getElementById("menu").style.display = "block";
	//	}
	//});

	document.addEventListener('DOMContentLoaded', setupSinglePageApplication);
</script>
